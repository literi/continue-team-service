<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>OAuth2 服务测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #555;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .response {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <h1>OAuth2 服务测试页面</h1>
    
    <div class="container">
        <h2>1. OAuth2 授权码流程测试</h2>
        <p>点击下方按钮开始 OAuth2 授权流程：</p>
        <button class="button" onclick="startOAuthFlow()">开始授权流程</button>
        <div id="authResponse" class="response"></div>
    </div>
    
    <div class="container">
        <h2>2. 令牌信息测试</h2>
        <p>使用获取到的访问令牌测试 API：</p>
        <button class="button" onclick="testApiWithToken()">测试 API</button>
        <div id="apiResponse" class="response"></div>
    </div>
    
    <div class="container">
        <h2>3. 令牌管理</h2>
        <button class="button" onclick="clearTokens()">清除令牌</button>
        <div id="tokenInfo" class="response"></div>
    </div>

    <script>
        // 配置参数
        const config = {
            clientId: 'client-app',
            clientSecret: '123456',
            redirectUri: 'http://127.0.0.1:8000',
            authorizationEndpoint: 'http://localhost:8080/oauth2/authorize',
            tokenEndpoint: 'http://localhost:8080/oauth2/token',
            userInfoEndpoint: 'http://localhost:8080/api/user'
        };
        
        // 页面加载时检查 URL 中的授权码
        window.onload = function() {
            checkForAuthorizationCode();
            displayTokenInfo();
        };
        
        // 检查 URL 中的授权码
        function checkForAuthorizationCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code) {
                document.getElementById('authResponse').textContent = '获取到授权码，正在交换令牌...';
                exchangeCodeForToken(code);
                // 清除 URL 中的参数
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        // 开始 OAuth2 授权流程
        function startOAuthFlow() {
            const state = generateRandomState();
            localStorage.setItem('oauth2_state', state);
            
            const authUrl = `${config.authorizationEndpoint}?` +
                `client_id=${config.clientId}&` +
                `redirect_uri=${encodeURIComponent(config.redirectUri)}&` +
                `response_type=code&` +
                `scope=openid profile email&` +
                `state=${state}`;
            
            window.location.href = authUrl;
        }
        
        // 交换授权码获取令牌
        function exchangeCodeForToken(code) {
            const data = {
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: config.redirectUri,
                client_id: config.clientId,
                client_secret: config.clientSecret
            };
            
            fetch(config.tokenEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Basic ' + btoa(`${config.clientId}:${config.clientSecret}`)
                },
                body: new URLSearchParams(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.access_token) {
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                    localStorage.setItem('id_token', data.id_token);
                    localStorage.setItem('token_type', data.token_type);
                    localStorage.setItem('expires_in', data.expires_in);
                    
                    document.getElementById('authResponse').textContent = '令牌获取成功！\n' + JSON.stringify(data, null, 2);
                    displayTokenInfo();
                } else {
                    document.getElementById('authResponse').textContent = '令牌获取失败：' + JSON.stringify(data, null, 2);
                }
            })
            .catch(error => {
                document.getElementById('authResponse').textContent = '错误：' + error.message;
            });
        }
        
        // 使用令牌测试 API
        function testApiWithToken() {
            const accessToken = localStorage.getItem('access_token');
            
            if (!accessToken) {
                document.getElementById('apiResponse').textContent = '请先获取访问令牌';
                return;
            }
            
            fetch(config.userInfoEndpoint, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('API 请求失败：' + response.status);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('apiResponse').textContent = 'API 响应：\n' + JSON.stringify(data, null, 2);
            })
            .catch(error => {
                document.getElementById('apiResponse').textContent = '错误：' + error.message;
            });
        }
        
        // 清除令牌
        function clearTokens() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('id_token');
            localStorage.removeItem('token_type');
            localStorage.removeItem('expires_in');
            localStorage.removeItem('oauth2_state');
            
            document.getElementById('tokenInfo').textContent = '令牌已清除';
            document.getElementById('authResponse').textContent = '';
            document.getElementById('apiResponse').textContent = '';
        }
        
        // 显示令牌信息
        function displayTokenInfo() {
            const accessToken = localStorage.getItem('access_token');
            const tokenType = localStorage.getItem('token_type');
            
            if (accessToken) {
                document.getElementById('tokenInfo').textContent = '当前令牌信息：\n' +
                    '令牌类型：' + tokenType + '\n' +
                    '访问令牌：' + accessToken.substring(0, 50) + '...';
            } else {
                document.getElementById('tokenInfo').textContent = '未获取到令牌';
            }
        }
        
        // 生成随机状态值
        function generateRandomState() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
    </script>
</body>
</html>