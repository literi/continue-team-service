<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>后台管理</title>
    <link rel="stylesheet" th:href="@{/css/home.css}" />
    <script th:src="@{/js/htmx-2.0.8.min.js}"></script>
  </head>
  <body>
    <div class="admin-container">
      <!-- 侧边栏 -->
      <th:block
        th:replace="~{fragments/layout/sidebar :: sidebar(${sidebarCollapsed})}"
      ></th:block>

      <div class="main-wrapper">
        <!-- 顶栏 -->
        <header
          th:replace="~{fragments/layout/header :: header(${loginUser})}"
        ></header>

        <!-- 主内容区：初始为仪表盘，HTMX 按需替换 -->
        <main class="main-content">
          <div id="contentContainer" class="content-inner">
            <th:block
              th:replace="~{fragments/content/dashboard :: dashboard}"
            ></th:block>
          </div>
        </main>
      </div>
    </div>

    <script>
      // 侧栏折叠：点击顶栏按钮切换
      document.addEventListener("DOMContentLoaded", function () {
        document
          .querySelector(".toggle-btn")
          ?.addEventListener("click", function (e) {
            var sidebar = document.querySelector(".sidebar");
            if (sidebar) sidebar.classList.toggle("collapsed");
          });

        // 侧边栏菜单事件代理和 hash 路由管理
        initSidebarNavigation();
      });

      /**
       * 初始化侧边栏导航
       * 使用事件代理处理菜单点击，支持 hash 路由
       */
      function initSidebarNavigation() {
        const menuList = document.getElementById("sidebarMenu");
        if (!menuList) return;

        // 事件代理：处理菜单点击
        menuList.addEventListener("click", function (e) {
          const menuLink = e.target.closest(".menu-link");
          if (!menuLink) return;

          e.preventDefault();

          const url = menuLink.getAttribute("data-url");
          const hash = menuLink.getAttribute("data-hash");

          if (url && hash) {
            // 如果点击的 hash 与当前 hash 相同，不重复加载
            if (window.location.hash === hash) {
              return;
            }
            // 更新 hash 路由（hashchange 事件会自动触发 handleHashChange）
            window.location.hash = hash;
          }
        });

        let isInitialLoad = true; // 标记是否是首次加载

        // 监听 hash 变化（浏览器前进/后退或菜单点击）
        const hashChangeHandler = function () {
          // 首次加载时不处理 hashchange（避免重复请求）
          if (isInitialLoad) {
            isInitialLoad = false;
            return;
          }
          handleHashChange();
        };
        window.addEventListener("hashchange", hashChangeHandler);

        // 页面加载时根据 hash 加载内容
        const initialHash = window.location.hash;
        if (!initialHash || initialHash === "#" || initialHash === "") {
          // 首次加载且没有 hash，设置默认 hash 但不触发请求（内容已通过服务端渲染）
          const defaultHash = "#/admin/load-content/dashboard";
          // 使用 replaceState 避免触发 hashchange 事件
          if (history.replaceState) {
            history.replaceState(null, null, defaultHash);
          } else {
            // 如果不支持 replaceState，临时移除监听器避免触发
            window.removeEventListener("hashchange", hashChangeHandler);
            window.location.hash = defaultHash;
            // 延迟恢复监听器
            setTimeout(function() {
              window.addEventListener("hashchange", hashChangeHandler);
            }, 100);
          }
          // 只更新激活状态，不加载内容
          updateMenuActiveState(defaultHash);
          isInitialLoad = false;
        } else {
          // 有 hash，需要加载对应内容（刷新页面时）
          handleHashChange();
          isInitialLoad = false;
        }
      }

      /**
       * 处理 hash 变化
       */
      function handleHashChange() {
        let hash = window.location.hash;

        // 如果没有 hash 或 hash 为空，设置默认 hash 为仪表盘
        if (!hash || hash === "#" || hash === "") {
          hash = "#/admin/load-content/dashboard";
          // 使用 replaceState 避免在历史记录中添加新条目
          if (history.replaceState) {
            history.replaceState(null, null, hash);
          } else {
            window.location.hash = hash;
          }
        }

        const menuLink = document.querySelector(
          `.menu-link[data-hash="${hash}"]`
        );
        if (menuLink) {
          const url = menuLink.getAttribute("data-url");
          loadContentByHash(hash, url);
        } else {
          // 如果没有匹配的 hash，默认加载仪表盘
          hash = "#/admin/load-content/dashboard";
          if (history.replaceState) {
            history.replaceState(null, null, hash);
          } else {
            window.location.hash = hash;
          }
          loadContentByHash(hash, "/admin/load-content/dashboard");
        }
      }

      /**
       * 根据 hash 加载内容并更新激活状态
       */
      function loadContentByHash(hash, url) {
        if (!url) return;

        // 更新菜单激活状态
        updateMenuActiveState(hash);

        // 使用 HTMX 加载内容
        htmx.ajax("GET", url, {
          target: "#contentContainer",
          swap: "innerHTML",
        });
      }

      /**
       * 更新菜单激活状态
       */
      function updateMenuActiveState(hash) {
        // 移除所有激活状态
        document.querySelectorAll(".menu-link").forEach((link) => {
          link.classList.remove("active");
        });

        // 设置当前 hash 对应的菜单为激活状态
        const activeLink = document.querySelector(
          `.menu-link[data-hash="${hash}"]`
        );
        if (activeLink) {
          activeLink.classList.add("active");
        }
      }

      document.addEventListener("htmx:responseError", function (event) {
        const xhr = event.detail.xhr;
        if (xhr.status === 404) {
          alert("全局提示：请求的资源不存在（404）");
        }
      });
    </script>
  </body>
</html>
