# 可扩展的团队级大模型服务网关 - 架构设计文档

## 1. 项目概述

搭建一个可扩展的团队级大模型服务网关，核心需求是：支持切换不同底层大模型、统一输出 OpenAPI 格式，且预留 MCP 服务和 Skill 技能的扩展能力。这个架构需要具备灵活性、可扩展性和统一性。

## 2. 核心功能

- 对接各类大模型（OpenAI、智谱、通义、本地模型等），封装统一调用接口
- 接收底层模型返回结果，统一转换为 OpenAPI 标准格式输出
- 实现各类业务技能（如数据提取、文档总结、代码生成等），可被上层调用
- **数据库存储配置**：所有配置（模型、Skill、MCP）存储在数据库中，支持动态更新
- **角色权限管理**：基于角色的访问控制（RBAC），不同角色有不同的操作权限
- **OAuth2 认证集成**：与现有 OAuth2 服务（端口 8080）集成，验证 JWT token 并获取用户角色权限

## 3. 设计原则

- **接口统一化**：所有底层模型、Skill、MCP 都实现统一抽象接口，降低耦合
- **配置可动态化**：模型选择、技能启用通过数据库配置实现，无需重启服务
- **扩展无侵入化**：新增模型 / MCP/Skill 时，只需新增实现类和数据库配置，无需修改现有核心代码
- **输出标准化**：强制统一为 OpenAPI 格式（OpenAI Chat Completions 响应格式）
- **认证统一化**：统一使用 OAuth2 JWT token 进行认证和授权
- **权限细粒度化**：基于角色的权限控制，支持模型、Skill、MCP 的访问权限管理

## 4. 数据库设计

### 4.1 配置表结构

#### 4.1.1 模型配置表 (llm_model_config)

存储大模型提供者的配置信息，支持多租户和权限控制。

#### 4.1.2 Skill 配置表 (llm_skill_config)

存储业务技能的配置信息。

#### 4.1.3 MCP 配置表 (llm_mcp_config)

存储 MCP 服务的配置信息。

#### 4.1.4 权限定义表

复用现有 OAuth2 服务的权限表（sys_permission），新增网关相关权限：

- `llm:model:view` - 查看模型列表
- `llm:model:use` - 使用模型
- `llm:model:manage` - 管理模型配置（增删改）
- `llm:skill:view` - 查看技能列表
- `llm:skill:use` - 使用技能
- `llm:skill:manage` - 管理技能配置
- `llm:mcp:view` - 查看 MCP 服务列表
- `llm:mcp:use` - 使用 MCP 服务
- `llm:mcp:manage` - 管理 MCP 配置

### 4.2 角色定义

- **管理员 (admin)**：拥有所有权限，可以管理所有配置
- **开发者 (developer)**：可以使用模型和技能，可以管理自己创建的配置
- **普通用户 (user)**：只能使用已授权的模型和技能
- **只读用户 (viewer)**：只能查看配置，不能使用

## 5. 权限控制流程

1. 用户请求携带 OAuth2 JWT token
2. 网关验证 token，从 OAuth2 服务获取用户信息和角色权限
3. 根据请求的资源（模型/Skill/MCP）和操作类型（查看/使用/管理）检查权限
4. 权限通过后执行请求，否则返回 403 Forbidden

## 6. 架构设计

### 6.1 分层架构

```
┌─────────────────────────────────────────┐
│         API Gateway Layer              │
│  (FastAPI + OAuth2 + Permission)       │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Permission Check Middleware        │
│  (角色权限验证、资源访问控制)            │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Config Service Layer               │
│  (数据库配置管理、缓存)                  │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Request Router & Load Balancer     │
│  (模型选择、负载均衡、故障转移)          │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Skill & MCP Layer                  │
│  (技能编排、MCP服务调用)                 │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Model Adapter Layer                 │
│  (统一模型接口、格式转换)                │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│      Provider Implementations           │
│  (OpenAI、智谱、通义、本地模型等)        │
└─────────────────────────────────────────┘
```

### 6.2 核心组件

1. **认证中间件**：验证 OAuth2 JWT token，从现有服务获取用户信息和角色权限
2. **权限检查中间件**：根据用户角色和资源类型检查访问权限
3. **配置服务**：从数据库读取配置，支持缓存和热更新
4. **插件加载器**：动态加载模型提供者、Skill、MCP 服务
5. **响应转换器**：统一转换为 OpenAI Chat Completions 格式

## 7. 技术栈

- **Web 框架**：FastAPI（高性能、自动生成 OpenAPI 文档）
- **数据库**：SQLAlchemy + Alembic（ORM 和数据库迁移）
- **认证**：PyJWT + httpx（调用 OAuth2 服务验证 token）
- **权限**：基于角色的访问控制（RBAC）
- **配置管理**：数据库存储 + Redis 缓存（可选）
- **插件系统**：importlib（动态加载）
- **异步支持**：asyncio + httpx（异步 HTTP 客户端）
- **日志**：loguru
